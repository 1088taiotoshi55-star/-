<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”»åƒPDFå¤‰æ›ï¼ˆæ‰‹å‹•ä¿å­˜ç‰ˆï¼‰</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; text-align: center; }
        .preview img { width: 100px; height: 100px; object-fit: cover; margin: 5px; border: 1px solid #ccc; border-radius: 4px; }
        #debugLog { background: #f0f0f0; padding: 10px; margin-top: 20px; text-align: left; font-size: 12px; height: 120px; overflow-y: scroll; border: 1px solid #999; }
        button { padding: 12px 24px; font-size: 16px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 15px; }
        button:disabled { background-color: #ccc; }
        
        /* æ–°ã—ãè¿½åŠ ã—ãŸãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #downloadArea { margin-top: 20px; padding: 20px; border: 2px dashed #007bff; display: none; background: #e7f3ff; }
        #finalLink { font-size: 20px; font-weight: bold; color: #d00; text-decoration: underline; cursor: pointer; }
    </style>
</head>
<body>

    <h2>ğŸ“· ç”»åƒPDFå¤‰æ›ï¼ˆAndroidå¯¾å¿œç‰ˆï¼‰</h2>
    <p>å†™çœŸã‚’é¸ã‚“ã§ãã ã•ã„</p>
    <input type="file" id="imageInput" multiple onchange="processFiles(this)">
    
    <div id="previewArea" class="preview"></div>
    <button id="convertBtn" onclick="convertToPDF()" disabled>PDFã‚’ä½œæˆã™ã‚‹</button>

    <div id="downloadArea">
        <p>ğŸ‰ PDFãŒå®Œæˆã—ã¾ã—ãŸï¼<br>ä¸‹ã®ãƒªãƒ³ã‚¯ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ï¼š</p>
        <a id="finalLink" href="#" download="photos.pdf">ğŸ‘‰ ã“ã“ã‚’ã‚¿ãƒƒãƒ—ã—ã¦PDFã‚’ä¿å­˜ ğŸ‘ˆ</a>
    </div>

    <h3>çŠ¶æ³ãƒ­ã‚°</h3>
    <div id="debugLog">æº–å‚™å®Œäº†ã€‚</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        var selectedImages = [];
        
        function log(msg) {
            var box = document.getElementById('debugLog');
            box.innerHTML = "> " + msg + "<br>" + box.innerHTML;
        }

        function processFiles(input) {
            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ã‚’éš ã™
            document.getElementById('downloadArea').style.display = 'none';
            
            var files = input.files;
            var previewArea = document.getElementById('previewArea');
            var convertBtn = document.getElementById('convertBtn');

            if (!files || files.length === 0) return;

            previewArea.innerHTML = '';
            selectedImages = [];
            convertBtn.disabled = true;

            var loadedCount = 0;
            log(files.length + "æšã®ç”»åƒã‚’å‡¦ç†ä¸­...");

            for (var i = 0; i < files.length; i++) {
                (function(index) {
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        selectedImages[index] = e.target.result;
                        var img = document.createElement('img');
                        img.src = e.target.result;
                        previewArea.appendChild(img);
                        loadedCount++;
                        
                        if (loadedCount === files.length) {
                            convertBtn.disabled = false;
                            log("æº–å‚™å®Œäº†ã€‚ã€ŒPDFã‚’ä½œæˆã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");
                        }
                    };
                    reader.readAsDataURL(files[index]);
                })(i);
            }
        }

        function convertToPDF() {
            log("PDFãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆä¸­...");
            if (!window.jspdf) { alert("ã‚¨ãƒ©ãƒ¼: ãƒ©ã‚¤ãƒ–ãƒ©ãƒªæœªãƒ­ãƒ¼ãƒ‰"); return; }

            try {
                var jsPDF = window.jspdf.jsPDF;
                var doc = new jsPDF();
                
                var pageWidth = doc.internal.pageSize.getWidth();
                var pageHeight = doc.internal.pageSize.getHeight();
                var margin = 10;

                var validImages = selectedImages.filter(function(n){ return n != undefined });

                for (var i = 0; i < validImages.length; i++) {
                    var imgData = validImages[i];
                    if (i > 0) doc.addPage();

                    var imgProps = doc.getImageProperties(imgData);
                    var ratio = imgProps.width / imgProps.height;
                    var imgWidth = pageWidth - (margin * 2);
                    var imgHeight = imgWidth / ratio;

                    if (imgHeight > (pageHeight - margin * 2)) {
                        imgHeight = pageHeight - (margin * 2);
                        imgWidth = imgHeight * ratio;
                    }
                    doc.addImage(imgData, 'JPEG', margin, margin, imgWidth, imgHeight);
                }

                // ã€é‡è¦ã€‘ã“ã“ã‚’å¤‰ãˆã¾ã—ãŸ
                // ã„ããªã‚Šä¿å­˜ã›ãšã€ãƒ‡ãƒ¼ã‚¿URLã¨ã—ã¦ãƒªãƒ³ã‚¯ã«åŸ‹ã‚è¾¼ã¿ã¾ã™
                var pdfBlob = doc.output('blob');
                var url = URL.createObjectURL(pdfBlob);
                
                var link = document.getElementById('finalLink');
                link.href = url;
                
                // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
                document.getElementById('downloadArea').style.display = 'block';
                log("â˜…ä½œæˆæˆåŠŸï¼ç”»é¢ã«å‡ºãŸèµ¤ã„ãƒªãƒ³ã‚¯ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");

            } catch (e) {
                log("å¤±æ•—: " + e.message);
                alert("ã‚¨ãƒ©ãƒ¼: " + e.message);
            }
        }
    </script>
</body>
</html>
